services:
  app:
    image: ghcr.io/brendanlong/clawed-burrow:latest
    ports:
      - '3000:3000'
    environment:
      - DATABASE_URL=file:/data/db/prod.db
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      # Host path to Claude auth directory - used for bind mounts in session containers
      # Must be an absolute path on the Docker host (not inside this container)
      - CLAUDE_AUTH_PATH=${CLAUDE_AUTH_PATH:-${HOME}/.claude}
      - DATA_DIR=/data
      - NODE_ENV=production
      - PASSWORD_HASH=${PASSWORD_HASH}
      # Tell the app which runner image to use for Claude sessions
      - CLAUDE_RUNNER_IMAGE=ghcr.io/brendanlong/clawed-burrow-runner:latest
      # Optional: shared pnpm store path on host (for faster installs)
      - PNPM_STORE_PATH=${PNPM_STORE_PATH:-}
      # Optional: shared Gradle cache path on host (for faster builds)
      - GRADLE_USER_HOME=${GRADLE_USER_HOME:-}
    volumes:
      - app-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount claude auth so app can verify it exists (the actual path is passed via CLAUDE_AUTH_PATH env var)
      - ${CLAUDE_AUTH_PATH:-${HOME}/.claude}:/claude-auth
    restart: unless-stopped
    depends_on:
      - migrate

  migrate:
    image: ghcr.io/brendanlong/clawed-burrow:latest
    command: npx prisma migrate deploy
    environment:
      - DATABASE_URL=file:/data/db/prod.db
    volumes:
      - app-data:/data

  # Watchtower - automatically updates containers when new images are pushed
  watchtower:
    image: nickfedor/watchtower
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      # Check for updates every 5 minutes
      - WATCHTOWER_POLL_INTERVAL=300
      # Clean up old images after updating
      - WATCHTOWER_CLEANUP=true
      # Only update containers in this compose project
      - WATCHTOWER_SCOPE=clawed-burrow
    labels:
      - com.centurylinklabs.watchtower.scope=clawed-burrow
    restart: unless-stopped

  # For remote access, we recommend using Tailscale Funnel on the host
  # See: https://tailscale.com/kb/1223/funnel

volumes:
  app-data:
